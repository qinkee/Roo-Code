# 智能体实施关键信息与注意事项

## 🚨 实施前必读：关键架构理解

### ⭐ 核心架构概念（务必牢记）

```
void项目 = 标准VSCode应用 (统一代码库)
├── void贡献点 (智能体UI管理)
├── wechat贡献点 (IM系统界面) 
└── roo-code扩展 (built-in，核心智能体逻辑)

部署环境：
- PC环境: void桌面应用在用户PC上运行
- Docker环境: 同一个void应用在Docker容器中运行
- 关键：相同代码，不同网络策略
```

**❌ 错误理解**：PC智能体和云端智能体是不同的实现
**✅ 正确理解**：void是统一应用，A2A服务器在roo-code扩展中，所有环境共享相同代码

### ⭐ A2A服务器位置（绝对重要）

**A2A服务器实现位置**：
- **位置**: `/Users/david/ThinkgsProjects/Roo-Code/src/core/agent/A2AServer.ts`
- **运行**: 在roo-code扩展进程中（无论PC还是Docker环境）
- **不是**: 在void项目中实现独立服务器

**网络策略**：
- PC环境: localhost端口，网络不可直达，依赖IM桥接
- Docker环境: 容器IP端口，公网可直达，直连优先

## 🎯 项目职责分工

### Roo-Code扩展 (核心实现)
```
/Users/david/ThinkgsProjects/Roo-Code/src/core/agent/
├── A2AServer.ts              # A2A HTTP服务器 (核心!)
├── AgentInstanceRunner.ts    # Worker后台执行
├── AgentInstancePool.ts      # 实例池管理
├── ResourceManager.ts        # 资源管理
├── AgentRegistryClient.ts    # 注册中心客户端
├── NetworkProbeService.ts    # 网络探测
├── AgentTaskSeparator.ts     # 任务分离器
└── AgentManager.ts           # 扩展现有管理器
```

### void项目 (UI和命令)
```
/Users/david/ThinkgsProjects/shadan/void/src/vs/workbench/contrib/
├── void/browser/
│   ├── services/agentEndpointService.ts    # 端点管理服务
│   ├── commands/agentCommands.ts           # 智能体管理命令
│   └── react/AgentInstancePanel.tsx       # 实例管理面板
└── wechat/browser/
    ├── services/agentBridgeService.ts      # 调用roo-code桥接
    └── components/AgentBridgeStatus.tsx    # 桥接状态显示
```

### box-im项目 (IM桥接)
```
/Users/david/ThinkgsProjects/box-im/
├── im-server/src/services/AgentBridgeService.ts     # A2A桥接服务
├── im-server/src/routes/agentRoutes.ts              # 智能体API路由
└── im-web/src/services/agentBridgeClient.ts         # 桥接客户端
```

## 🔒 关键约束和原则

### 1. 数据一致性约束
- **用户隔离**: 智能体数据必须按用户隔离，使用 `roo:${userId}:agents` 格式
- **Redis同步**: 复用现有 CustomModesManager 的同步模式
- **本地优先**: VSCode GlobalState 作为主存储，Redis 作为同步

### 2. 后台执行约束
- **必须隔离**: 智能体运行不能阻塞用户UI线程
- **Worker优先**: 使用Worker Threads，不是Child Process（MVP阶段）
- **资源限制**: 严格的内存、CPU、文件操作限制
- **自动重启**: Worker异常时必须自动重启

### 3. 网络通信约束
- **探测先行**: 优先尝试直连，失败后降级IM桥接
- **权限验证**: 每次调用前必须验证共享范围权限
- **超时控制**: 网络请求必须有超时机制

## 📋 实施检查清单

### 阶段1验收标准
- [ ] AgentInstanceRunner在Worker中正常运行
- [ ] 智能体任务不干扰用户正常操作
- [ ] ResourceManager正确限制资源使用
- [ ] Redis同步机制与现有模式兼容
- [ ] 共享范围字段正确保存和加载

### 阶段2验收标准  
- [ ] A2AServer在roo-code扩展中启动HTTP服务
- [ ] PC环境localhost端口可访问
- [ ] Docker环境容器IP端口可访问
- [ ] 网络探测服务正确判断可达性
- [ ] IM桥接客户端能连接box-im服务器

### 集成验收标准
- [ ] void UI能正确显示智能体实例状态
- [ ] wechat贡献点能显示IM桥接状态
- [ ] box-im服务器能代理智能体间消息
- [ ] 权限验证在所有调用路径上生效

## ⚠️ 常见陷阱和误区

### 1. 架构理解陷阱
❌ **错误**: 认为需要在void项目中实现A2A服务器
✅ **正确**: A2A服务器在roo-code扩展中实现

❌ **错误**: PC和云端智能体是不同实现
✅ **正确**: 相同void应用，不同部署环境

### 2. 数据同步陷阱
❌ **错误**: 直接使用Redis作为主存储
✅ **正确**: VSCode GlobalState主存储，Redis同步

❌ **错误**: 忽略用户切换时的数据隔离
✅ **正确**: 严格按 `roo:${userId}:` 格式隔离

### 3. 后台执行陷阱
❌ **错误**: 在主线程中运行智能体逻辑
✅ **正确**: 必须在Worker线程中隔离运行

❌ **错误**: 无限制的资源使用
✅ **正确**: 严格的配额限制和监控

### 4. 网络通信陷阱
❌ **错误**: 假设所有智能体都能直连
✅ **正确**: PC端不可直达，必须IM桥接

❌ **错误**: 跳过权限验证提高性能
✅ **正确**: 安全第一，每次调用必须验证

## 🔧 调试和故障排除

### 常见问题诊断
1. **智能体无法启动**: 检查Worker脚本生成和权限
2. **网络调用失败**: 检查探测服务和端点注册
3. **权限被拒绝**: 检查共享范围和用户关系
4. **性能问题**: 检查资源使用和配额设置
5. **数据不同步**: 检查Redis连接和用户ID设置

### 日志记录要求
```typescript
// 必须记录的关键事件
console.log('[AgentInstanceRunner] Starting agent:', agentId)
console.log('[A2AServer] Received request from:', sourceAgentId)  
console.log('[NetworkProbe] Testing connectivity to:', endpoint)
console.error('[ResourceManager] Quota exceeded:', instanceId)
```

## 📞 关键依赖项目

### 现有组件依赖
1. **CustomModesManager**: Redis同步模式参考
2. **UserContextManager**: 用户切换集成
3. **VoidBridge**: void与roo-code通信
4. **IM WebSocket**: 现有IM通信机制

### 外部依赖
1. **a2a-js**: 智能体间通信协议
2. **Redis**: 注册中心和同步存储
3. **Worker Threads**: Node.js后台执行

## 🎭 测试策略

### 单元测试重点
- AgentInstanceRunner的Worker线程管理
- ResourceManager的配额计算和限制
- 权限验证的各种场景覆盖
- 网络探测的超时和重试机制

### 集成测试重点
- 跨项目的消息传递
- 用户切换时的数据隔离
- PC和Docker环境的网络策略
- IM桥接的端到端流程

### 性能测试重点
- 多智能体并发运行
- 长时间运行的内存泄露
- 网络延迟对用户体验的影响
- Redis同步的性能瓶颈

## 🚀 部署注意事项

### PC环境部署
- void应用通过扩展商店或direct install
- A2A服务器绑定localhost随机端口
- 依赖box-im服务器进行智能体间通信

### Docker环境部署
- 相同void应用在容器中运行
- A2A服务器绑定容器IP:端口
- 需要配置网络策略允许智能体间直连

### 版本兼容性
- 确保所有项目版本一致性
- API接口向后兼容
- 数据格式迁移策略

---

## 💡 最重要的提醒

**实施成功的关键**: 始终记住这是一个统一的void应用，智能体核心逻辑在roo-code扩展中，其他项目只是UI和桥接服务。

**完成标准**: 用户可以在PC和Docker环境中无缝使用智能体，智能体间可以通过直连或IM桥接进行通信，整个过程对用户透明且不影响正常工作流程。

**联系方式**: 如有架构理解问题，请参考本文档的架构图和职责分工部分，避免走错方向。
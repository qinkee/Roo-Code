<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¶å®½å­—ç¬¦ç¼–ç æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h2 {
            margin-top: 0;
            color: #4CAF50;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .output {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            min-height: 50px;
            border: 1px solid #e0e0e0;
        }
        .output pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-item {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>ğŸ” é›¶å®½å­—ç¬¦ç¼–ç æµ‹è¯•å·¥å…·</h1>
    
    <div class="info">
        <strong>è®¾è®¡ç†å¿µï¼š</strong>é›¶å®½å­—ç¬¦ç¼–ç ç”¨äºåœ¨ @æåŠç³»ç»Ÿä¸­éšå½¢ä¼ é€’<strong>å¿…è¦å‚æ•°</strong>ã€‚
        <br>
        <strong>ç²¾ç®€åŸåˆ™ï¼š</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
            <li><strong>ä»»åŠ¡(@ä»»åŠ¡)</strong>ï¼šåªä¼ é€’ <code>type</code>ã€<code>name</code>ã€<code>id</code></li>
            <li><strong>æ™ºèƒ½ä½“(@æ™ºèƒ½ä½“)</strong>ï¼šåªä¼ é€’ <code>type</code>ã€<code>name</code>ã€<code>modeId</code></li>
            <li>é¢å¤–å‚æ•°å¯åœ¨åç»­ç‰ˆæœ¬æŒ‰éœ€æ‰©å±•ï¼Œé¿å…è¿‡åº¦è®¾è®¡</li>
        </ul>
        ç¼–ç åçš„æ–‡æœ¬çœ‹èµ·æ¥å’ŒåŸæ–‡ä¸€æ ·ï¼Œä½†åŒ…å«äº†ä¸å¯è§çš„æ ¸å¿ƒå‚æ•°ã€‚
    </div>

    <div class="container">
        <!-- ç¼–ç é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ“ ç¼–ç æµ‹è¯•</h2>
            
            <label>æ˜¾ç¤ºæ–‡æœ¬ï¼š</label>
            <input type="text" id="displayText" value="@ä»»åŠ¡[ä¼˜åŒ–ä»£ç ]" style="width: 100%; padding: 8px; margin: 5px 0;">
            
            <label>å‚æ•°æ•°æ®ï¼ˆJSONï¼‰ï¼š</label>
            <textarea id="paramsInput">{
  "type": "task",
  "name": "ä¼˜åŒ–ä»£ç ",
  "id": "task-123"
}</textarea>
            
            <div style="margin-top: 10px;">
                <button onclick="testEncode()">ç¼–ç </button>
                <button onclick="createTaskMention()">åˆ›å»ºä»»åŠ¡æåŠ</button>
                <button onclick="createAgentMention()">åˆ›å»ºæ™ºèƒ½ä½“æåŠ</button>
            </div>
            
            <div class="output">
                <strong>ç¼–ç ç»“æœï¼š</strong>
                <pre id="encodeOutput"></pre>
            </div>
            
            <div class="stats" id="encodeStats"></div>
        </div>

        <!-- è§£ç é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ”“ è§£ç æµ‹è¯•</h2>
            
            <label>å¾…è§£ç æ–‡æœ¬ï¼š</label>
            <textarea id="decodeInput" placeholder="ç²˜è´´åŒ…å«é›¶å®½ç¼–ç çš„æ–‡æœ¬..."></textarea>
            
            <div style="margin-top: 10px;">
                <button onclick="testDecode()">è§£ç </button>
                <button onclick="cleanText()">æ¸…ç†é›¶å®½å­—ç¬¦</button>
                <button onclick="copyToClipboard()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
            
            <div class="output">
                <strong>è§£ç ç»“æœï¼š</strong>
                <pre id="decodeOutput"></pre>
            </div>
            
            <div class="output">
                <strong>æ¸…ç†åæ–‡æœ¬ï¼š</strong>
                <pre id="cleanOutput"></pre>
            </div>
        </div>
    </div>

    <!-- å¤åˆ¶ç²˜è´´æµ‹è¯• -->
    <div class="panel" style="margin-top: 20px;">
        <h2>ğŸ“‹ å¤åˆ¶ç²˜è´´æµ‹è¯•</h2>
        <p>æµ‹è¯•é›¶å®½ç¼–ç åœ¨å¤åˆ¶ç²˜è´´è¿‡ç¨‹ä¸­æ˜¯å¦ä¿ç•™ï¼š</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label>æºæ–‡æœ¬ï¼ˆåŒ…å«é›¶å®½ç¼–ç ï¼‰ï¼š</label>
                <div id="copySource" style="padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
                    ç‚¹å‡»"ç”Ÿæˆæµ‹è¯•æ–‡æœ¬"æŒ‰é’®åˆ›å»º
                </div>
                <button onclick="generateTestText()">ç”Ÿæˆæµ‹è¯•æ–‡æœ¬</button>
            </div>
            
            <div>
                <label>ç²˜è´´åŒºåŸŸï¼š</label>
                <textarea id="pasteArea" placeholder="å¤åˆ¶å·¦ä¾§æ–‡æœ¬åç²˜è´´åˆ°è¿™é‡Œ..." style="min-height: 60px;"></textarea>
                <button onclick="verifyPaste()">éªŒè¯ç²˜è´´å†…å®¹</button>
                <div id="pasteResult" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <script>
        // é›¶å®½å­—ç¬¦ç¼–ç å™¨å®ç°
        class ZeroWidthEncoder {
            static CHARS = {
                ZERO: '\u200B',
                ONE: '\u200C',
                SEPARATOR: '\u200D',
                START: '\uFEFF',
                END: '\u2060'
            };

            static VERSION = 1;

            static encode(params) {
                try {
                    const jsonStr = JSON.stringify(params);
                    const compressed = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                        return String.fromCharCode('0x' + p1);
                    }));
                    
                    const binary = this.stringToBinary(compressed);
                    const encoded = this.binaryToZeroWidth(binary);
                    const versioned = this.addVersionAndChecksum(encoded);
                    
                    return this.CHARS.START + versioned + this.CHARS.END;
                } catch (error) {
                    console.error('ç¼–ç é”™è¯¯:', error);
                    throw new Error('å‚æ•°ç¼–ç å¤±è´¥');
                }
            }

            static decode(text) {
                try {
                    const extracted = this.extractZeroWidthContent(text);
                    if (!extracted) return null;

                    const validated = this.validateAndExtract(extracted);
                    if (!validated) return null;

                    const binary = this.zeroWidthToBinary(validated);
                    const compressed = this.binaryToString(binary);
                    const jsonStr = decodeURIComponent(atob(compressed).split('').map(c => {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    return JSON.parse(jsonStr);
                } catch (error) {
                    console.error('è§£ç é”™è¯¯:', error);
                    return null;
                }
            }

            static stringToBinary(str) {
                return str.split('').map(char => char.charCodeAt(0).toString(2).padStart(16, '0')).join('');
            }

            static binaryToString(binary) {
                const chunks = binary.match(/.{1,16}/g) || [];
                return chunks.map(chunk => String.fromCharCode(parseInt(chunk, 2))).join('');
            }

            static binaryToZeroWidth(binary) {
                return binary.split('').map(bit => (bit === '0' ? this.CHARS.ZERO : this.CHARS.ONE)).join('');
            }

            static zeroWidthToBinary(zeroWidth) {
                return zeroWidth.split('').map(char => {
                    if (char === this.CHARS.ZERO) return '0';
                    if (char === this.CHARS.ONE) return '1';
                    return '';
                }).join('');
            }

            static addVersionAndChecksum(encoded) {
                const versionBinary = this.VERSION.toString(2).padStart(4, '0');
                const versionZW = this.binaryToZeroWidth(versionBinary);
                
                const checksum = encoded.length % 256;
                const checksumBinary = checksum.toString(2).padStart(8, '0');
                const checksumZW = this.binaryToZeroWidth(checksumBinary);
                
                return versionZW + this.CHARS.SEPARATOR + encoded + this.CHARS.SEPARATOR + checksumZW;
            }

            static validateAndExtract(content) {
                const parts = content.split(this.CHARS.SEPARATOR);
                if (parts.length !== 3) return null;

                const [versionZW, data, checksumZW] = parts;
                
                const version = parseInt(this.zeroWidthToBinary(versionZW), 2);
                if (version !== this.VERSION) {
                    console.warn('ç‰ˆæœ¬ä¸åŒ¹é…:', version);
                    return null;
                }
                
                const checksum = parseInt(this.zeroWidthToBinary(checksumZW), 2);
                const expectedChecksum = data.length % 256;
                if (checksum !== expectedChecksum) {
                    console.warn('æ ¡éªŒå’Œä¸åŒ¹é…');
                    return null;
                }
                
                return data;
            }

            static extractZeroWidthContent(text) {
                const startIdx = text.indexOf(this.CHARS.START);
                const endIdx = text.indexOf(this.CHARS.END);
                
                if (startIdx === -1 || endIdx === -1 || startIdx >= endIdx) {
                    return null;
                }
                
                return text.substring(startIdx + 1, endIdx);
            }

            static cleanText(text) {
                const allZeroWidth = [
                    this.CHARS.ZERO, this.CHARS.ONE, this.CHARS.SEPARATOR,
                    this.CHARS.START, this.CHARS.END,
                    '\u200E', '\u200F', '\uFEFF', '\u2060'
                ];
                
                let cleaned = text;
                allZeroWidth.forEach(char => {
                    cleaned = cleaned.replace(new RegExp(char, 'g'), '');
                });
                
                return cleaned;
            }

            static embedInText(displayText, params) {
                const encoded = this.encode(params);
                return displayText + encoded;
            }
        }

        // æµ‹è¯•å‡½æ•°
        function testEncode() {
            try {
                const displayText = document.getElementById('displayText').value;
                const paramsText = document.getElementById('paramsInput').value;
                const params = JSON.parse(paramsText);
                
                const result = ZeroWidthEncoder.embedInText(displayText, params);
                
                document.getElementById('encodeOutput').textContent = result;
                document.getElementById('decodeInput').value = result;
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                const stats = `
                    <div class="stat-item">
                        <div class="stat-label">åŸå§‹æ–‡æœ¬é•¿åº¦</div>
                        <div class="stat-value">${displayText.length}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç¼–ç åé•¿åº¦</div>
                        <div class="stat-value">${result.length}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">é›¶å®½å­—ç¬¦æ•°</div>
                        <div class="stat-value">${result.length - displayText.length}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ•°æ®å¤§å°</div>
                        <div class="stat-value">${new Blob([paramsText]).size} B</div>
                    </div>
                `;
                document.getElementById('encodeStats').innerHTML = stats;
                
            } catch (error) {
                document.getElementById('encodeOutput').innerHTML = 
                    `<span class="error">ç¼–ç å¤±è´¥: ${error.message}</span>`;
            }
        }

        function testDecode() {
            try {
                const text = document.getElementById('decodeInput').value;
                const decoded = ZeroWidthEncoder.decode(text);
                
                if (decoded) {
                    document.getElementById('decodeOutput').innerHTML = 
                        `<span class="success">è§£ç æˆåŠŸï¼š</span>\n${JSON.stringify(decoded, null, 2)}`;
                } else {
                    document.getElementById('decodeOutput').innerHTML = 
                        `<span class="error">æœªæ‰¾åˆ°é›¶å®½ç¼–ç æ•°æ®</span>`;
                }
                
                const cleaned = ZeroWidthEncoder.cleanText(text);
                document.getElementById('cleanOutput').textContent = cleaned;
                
            } catch (error) {
                document.getElementById('decodeOutput').innerHTML = 
                    `<span class="error">è§£ç å¤±è´¥: ${error.message}</span>`;
            }
        }

        function cleanText() {
            const text = document.getElementById('decodeInput').value;
            const cleaned = ZeroWidthEncoder.cleanText(text);
            document.getElementById('cleanOutput').textContent = cleaned;
            document.getElementById('decodeInput').value = cleaned;
        }

        function createTaskMention() {
            const taskName = 'ä¼˜åŒ–ä»£ç æ€§èƒ½';
            const taskId = 'task-' + Date.now();
            
            const displayText = `@ä»»åŠ¡[${taskName}]`;
            // ç²¾ç®€ç‰ˆï¼šåªä¼ é€’å¿…è¦å‚æ•°
            const params = {
                type: 'task',
                name: taskName,
                id: taskId  // ä»»åŠ¡IDæ˜¯å¿…è¦å‚æ•°
            };
            
            document.getElementById('displayText').value = displayText;
            document.getElementById('paramsInput').value = JSON.stringify(params, null, 2);
            testEncode();
        }

        function createAgentMention() {
            const agentName = 'Code Review';
            const modeId = 'code-review';
            
            const displayText = `@æ™ºèƒ½ä½“[${agentName}]`;
            // ç²¾ç®€ç‰ˆï¼šåªä¼ é€’å¿…è¦å‚æ•°
            const params = {
                type: 'agent',
                name: agentName,
                modeId: modeId  // æ¨¡å¼IDæ˜¯å¿…è¦å‚æ•°
            };
            
            document.getElementById('displayText').value = displayText;
            document.getElementById('paramsInput').value = JSON.stringify(params, null, 2);
            testEncode();
        }

        function copyToClipboard() {
            const text = document.getElementById('encodeOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        function generateTestText() {
            // ç²¾ç®€ç‰ˆï¼šåªä¼ é€’å¿…è¦å‚æ•°
            const testParams = {
                type: 'task',
                name: 'æµ‹è¯•ä»»åŠ¡',
                id: 'test-' + Date.now()
            };
            
            const testText = ZeroWidthEncoder.embedInText('@ä»»åŠ¡[æµ‹è¯•å¤åˆ¶ç²˜è´´]', testParams);
            document.getElementById('copySource').textContent = testText;
            
            // è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(testText).then(() => {
                alert('æµ‹è¯•æ–‡æœ¬å·²ç”Ÿæˆå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·ç²˜è´´åˆ°å³ä¾§åŒºåŸŸæµ‹è¯•');
            });
        }

        function verifyPaste() {
            const pastedText = document.getElementById('pasteArea').value;
            const decoded = ZeroWidthEncoder.decode(pastedText);
            
            const resultDiv = document.getElementById('pasteResult');
            if (decoded) {
                resultDiv.innerHTML = `
                    <div class="success">âœ… é›¶å®½ç¼–ç ä¿ç•™æˆåŠŸï¼</div>
                    <pre>${JSON.stringify(decoded, null, 2)}</pre>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">âŒ æœªæ£€æµ‹åˆ°é›¶å®½ç¼–ç </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆç¤ºä¾‹
        window.onload = function() {
            testEncode();
        };
    </script>
</body>
</html>